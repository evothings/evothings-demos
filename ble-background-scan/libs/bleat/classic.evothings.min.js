/* @license
 *
 * BLE Abstraction Tool: bluetooth helpers
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.bleatHelpers=b()}(this,function(){"use strict";function a(a){return"number"==typeof a&&(a=a.toString(16)),a=a.toLowerCase(),a.length<=8&&(a=("00000000"+a).slice(-8)+"-0000-1000-8000-00805f9b34fb"),32===a.length&&(a=a.match(/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})$/).splice(1).join("-")),a}function b(b){return e[b]&&(b=e[b]),a(b)}function c(b){return f[b]&&(b=f[b]),a(b)}function d(b){return g[b]&&(b=g[b]),a(b)}var e={alert_notification:6161,automation_io:6165,battery_service:6159,blood_pressure:6160,body_composition:6171,bond_management:6174,continuous_glucose_monitoring:6175,current_time:6149,cycling_power:6168,cycling_speed_and_cadence:6166,device_information:6154,environmental_sensing:6170,generic_access:6144,generic_attribute:6145,glucose:6152,health_thermometer:6153,heart_rate:6157,human_interface_device:6162,immediate_alert:6146,indoor_positioning:6177,internet_protocol_support:6176,link_loss:6147,location_and_navigation:6169,next_dst_change:6151,phone_alert_status:6158,pulse_oximeter:6178,reference_time_update:6150,running_speed_and_cadence:6164,scan_parameters:6163,tx_power:6148,user_data:6172,weight_scale:6173},f={aerobic_heart_rate_lower_limit:10878,aerobic_heart_rate_upper_limit:10884,aerobic_threshold:10879,age:10880,aggregate:10842,alert_category_id:10819,alert_category_id_bit_mask:10818,alert_level:10758,alert_notification_control_point:10820,alert_status:10815,altitude:10931,anaerobic_heart_rate_lower_limit:10881,anaerobic_heart_rate_upper_limit:10882,anaerobic_threshold:10883,analog:10840,apparent_wind_direction:10867,apparent_wind_speed:10866,"gap.appearance":10753,barometric_pressure_trend:10915,battery_level:10777,blood_pressure_feature:10825,blood_pressure_measurement:10805,body_composition_feature:10907,body_composition_measurement:10908,body_sensor_location:10808,bond_management_control_point:10916,bond_management_feature:10917,boot_keyboard_input_report:10786,boot_keyboard_output_report:10802,boot_mouse_input_report:10803,"gap.central_address_resolution_support":10918,cgm_feature:10920,cgm_measurement:10919,cgm_session_run_time:10923,cgm_session_start_time:10922,cgm_specific_ops_control_point:10924,cgm_status:10921,csc_feature:10844,csc_measurement:10843,current_time:10795,cycling_power_control_point:10854,cycling_power_feature:10853,cycling_power_measurement:10851,cycling_power_vector:10852,database_change_increment:10905,date_of_birth:10885,date_of_threshold_assessment:10886,date_time:10760,day_date_time:10762,day_of_week:10761,descriptor_value_changed:10877,"gap.device_name":10752,dew_point:10875,digital:10838,dst_offset:10765,elevation:10860,email_address:10887,exact_time_256:10764,fat_burn_heart_rate_lower_limit:10888,fat_burn_heart_rate_upper_limit:10889,firmware_revision_string:10790,first_name:10890,five_zone_heart_rate_limits:10891,floor_number:10930,gender:10892,glucose_feature:10833,glucose_measurement:10776,glucose_measurement_context:10804,gust_factor:10868,hardware_revision_string:10791,heart_rate_control_point:10809,heart_rate_max:10893,heart_rate_measurement:10807,heat_index:10874,height:10894,hid_control_point:10828,hid_information:10826,hip_circumference:10895,humidity:10863,"ieee_11073-20601_regulatory_certification_data_list":10794,indoor_positioning_configuration:10925,intermediate_blood_pressure:10806,intermediate_temperature:10782,irradiance:10871,language:10914,last_name:10896,latitude:10926,ln_control_point:10859,ln_feature:10858,"local_east_coordinate.xml":10929,local_north_coordinate:10928,local_time_information:10767,location_and_speed:10855,location_name:10933,longitude:10927,magnetic_declination:10796,magnetic_flux_density_2D:10912,magnetic_flux_density_3D:10913,manufacturer_name_string:10793,maximum_recommended_heart_rate:10897,measurement_interval:10785,model_number_string:10788,navigation:10856,new_alert:10822,"gap.peripheral_preferred_connection_parameters":10756,"gap.peripheral_privacy_flag":10754,plx_continuous_measurement:10847,plx_features:10848,plx_spot_check_measurement:10846,pnp_id:10832,pollen_concentration:10869,position_quality:10857,pressure:10861,protocol_mode:10830,rainfall:10872,"gap.reconnection_address":10755,record_access_control_point:10834,reference_time_information:10772,report:10829,report_map:10827,resting_heart_rate:10898,ringer_control_point:10816,ringer_setting:10817,rsc_feature:10836,rsc_measurement:10835,sc_control_point:10837,scan_interval_window:10831,scan_refresh:10801,sensor_location:10845,serial_number_string:10789,"gatt.service_changed":10757,software_revision_string:10792,sport_type_for_aerobic_and_anaerobic_thresholds:10899,supported_new_alert_category:10823,supported_unread_alert_category:10824,system_id:10787,temperature:10862,temperature_measurement:10780,temperature_type:10781,three_zone_heart_rate_limits:10900,time_accuracy:10770,time_source:10771,time_update_control_point:10774,time_update_state:10775,time_with_dst:10769,time_zone:10766,true_wind_direction:10865,true_wind_speed:10864,two_zone_heart_rate_limit:10901,tx_power_level:10759,uncertainty:10932,unread_alert_status:10821,user_control_point:10911,user_index:10906,uv_index:10870,vo2_max:10902,waist_circumference:10903,weight:10904,weight_measurement:10909,weight_scale_feature:10910,wind_chill:10873},g={"gatt.characteristic_extended_properties":10496,"gatt.characteristic_user_description":10497,"gatt.client_characteristic_configuration":10498,"gatt.server_characteristic_configuration":10499,"gatt.characteristic_presentation_format":10500,"gatt.characteristic_aggregate_format":10501,valid_range:10502,external_report_reference:10503,report_reference:10504,number_of_digitals:10505,value_trigger_setting:10506,es_configuration:10507,es_measurement:10508,es_trigger_setting:10509,time_trigger_setting:10510};return{Services:e,Characteristics:f,Descriptors:g,getCanonicalUUID:a,getServiceUUID:b,getCharacteristicUUID:c,getDescriptorUUID:d}}),/* @license
 *
 * BLE Abstraction Tool: core functionality - classic specification
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["bluetooth.helpers"],b):"object"==typeof exports?module.exports=b(require("./bluetooth.helpers")):a.bleat=b(a.bleatHelpers)}(this,function(a){"use strict";function b(a,b){return function(c){a&&a(b+": "+c)}}function c(a){return function(){if("function"==typeof a){var b=[].slice.call(arguments);a.apply(this,b)}}}function d(a,b){var c=0,d=!1;this.addCallback=function(b){return c++,d=!0,function(){b&&b.apply(null,arguments),0===--c&&a&&a()}},this.error=function(){b&&b.apply(null,arguments),0===--c&&a&&a()},this.finish=function(){!d&&a&&a()}}var e=null,f={},g=function(a){this._handle=a._handle,this.address=a._handle,this.name=a.name,this.serviceUUIDs=a.uuids,this.adData=a.adData,this.connected=!1,this.services={}};g.prototype.hasService=function(a){return this.serviceUUIDs.some(function(b){return b===a})},g.prototype.connect=function(a,d,f,g){e.connect(this._handle,function(){return this.connected=!0,"boolean"==typeof f&&(g=f,f=null),g?c(a)():void this.discoverAll(a,f)}.bind(this),function(){this.connected=!1,this.services={},c(d)()}.bind(this),b(f,"connect error"))},g.prototype.disconnect=function(a){e.disconnect(this._handle,b(a,"disconnect error"))},g.prototype.discoverServices=function(a,c,d){return this.connected===!1?b(d,"discovery error")("device not connected"):("function"==typeof a?(c=a,a=[]):"string"==typeof a&&(a=[a]),void e.discoverServices(this._handle,a,function(a){a.forEach(function(a){this.services[a.uuid]=new h(a)},this),c&&c()}.bind(this),b(d,"service discovery error")))},g.prototype.discoverAll=function(a,c){if(this.connected===!1)return b(c,"discovery error")("device not connected");var e=new d(a,c);this.discoverServices(e.addCallback(function(){Object.keys(this.services).forEach(function(a){var b=this.services[a];b.discoverIncludedServices(e.addCallback(),e.error),b.discoverCharacteristics(e.addCallback(function(){Object.keys(b.characteristics).forEach(function(a){var c=b.characteristics[a];c.discoverDescriptors(e.addCallback(),e.error)},this)}.bind(this)),e.error)},this)}.bind(this)),e.error),e.finish()};var h=function(a){this._handle=a._handle,this.uuid=a.uuid,this.primary=a.primary,this.includedServices={},this.characteristics={}};h.prototype.discoverIncludedServices=function(a,c,d){"function"==typeof a?(c=a,a=[]):"string"==typeof a&&(a=[a]),e.discoverIncludedServices(this._handle,a,function(a){a.forEach(function(a){this.includedServices[a.uuid]=new h(a)},this),c&&c()}.bind(this),b(d,"included service discovery error"))},h.prototype.discoverCharacteristics=function(a,c,d){"function"==typeof a?(c=a,a=[]):"string"==typeof a&&(a=[a]),e.discoverCharacteristics(this._handle,a,function(a){a.forEach(function(a){this.characteristics[a.uuid]=new i(a)},this),c&&c()}.bind(this),b(d,"characteristic discovery error"))};var i=function(a){this._handle=a._handle,this.uuid=a.uuid,this.properties=a.properties,this.descriptors={}};i.prototype.discoverDescriptors=function(a,c,d){"function"==typeof a?(c=a,a=[]):"string"==typeof a&&(a=[a]),e.discoverDescriptors(this._handle,a,function(a){a.forEach(function(a){this.descriptors[a.uuid]=new j(a)},this),c&&c()}.bind(this),b(d,"descriptor discovery error"))},i.prototype.read=function(a,d){e.readCharacteristic(this._handle,c(a),b(d,"read characteristic error"))},i.prototype.write=function(a,d,f){e.writeCharacteristic(this._handle,a,c(d),b(f,"write characteristic error"))},i.prototype.enableNotify=function(a,d,f){e.enableNotify(this._handle,c(a),c(d),b(f,"enable notify error"))},i.prototype.disableNotify=function(a,d){e.disableNotify(this._handle,c(a),b(d,"disable notify error"))};var j=function(a){this._handle=a._handle,this.uuid=a.uuid};return j.prototype.read=function(a,d){e.readDescriptor(this._handle,c(a),b(d,"read descriptor error"))},j.prototype.write=function(a,d,f){e.writeDescriptor(this._handle,a,c(d),b(f,"write descriptor error"))},{_addAdapter:function(a,b){f[a]=b,e=b},startScan:function(a,c,d,f,h){"function"==typeof a?(h=f,f=d,d=c,c=a,a=[]):"string"==typeof a&&(a=[a]),e.stopScan(b(f,"stop scan error"));var i={};e.startScan(a,function(a){var b=new g(a);i[b.address]&&!h||(i[b.address]=b,c&&c(b))}.bind(this),d,b(f,"scan error"))},stopScan:function(a){e.stopScan(b(a,"stop scan error"))}}}),function(a,b){"function"==typeof define&&define.amd?define(["bleat","bluetooth.helpers"],b.bind(this,a)):"object"==typeof exports?module.exports=function(c){return b(a,c,require("./bluetooth.helpers"))}:b(a,a.bleat,a.bleatHelpers)}(this,function(a,b,c){"use strict";function d(b){a.evothings&&evothings.ble?b():document.addEventListener("deviceready",b)}function e(a){var b=x[a];b&&(evothings.ble.close(b),delete x[a],f(b,y),f(b,z,!0),f(b,A))}function f(a,b,c){for(var d in b)a===b[d]&&(delete b[d],c&&B[d]&&delete B[d])}function g(a,b){var c=x[a];return c?c:(b&&b("Device does not exist for device id: "+a),null)}function h(a,b){var c=y[a];return c?c:(b&&b("Device does not exist for service handle: "+a),null)}function i(a,b){var c=z[a];return c?c:(b&&b("Device does not exist for characteristic handle: "+a),null)}function j(a,b,c,d){function e(b){evothings.ble.writeDescriptor(a,b,new Uint8Array([1,0]),function(){c()},function(a){d(a)})}function f(){w.discoverDescriptors(b,"00002902-0000-1000-8000-00805f9b34fb",function(a){var c=B[b];c?e(c):d("Could not find CCCD for characteristic: "+b)},function(a){d(a)})}var g=B[b];g?e(g):f()}function k(a){var b={};return b._handle=a.address,b.id=a.address,b.name=a.name,b.uuids=[],b.adData={},b.adData.rssi=a.rssi,b.adData.txPower=null,b.adData.serviceData={},b.adData.manufacturerData=null,a.advertisementData?l(a,b):a.scanRecord&&m(a,b),b}function l(a,b){if(a.advertisementData){if(a.advertisementData.kCBAdvDataLocalName&&(b.name=a.advertisementData.kCBAdvDataLocalName),a.advertisementData.kCBAdvDataTxPowerLevel&&(b.adData.txPower=a.advertisementData.kCBAdvDataTxPowerLevel),a.advertisementData.kCBAdvDataServiceUUIDs&&a.advertisementData.kCBAdvDataServiceUUIDs.forEach(function(a){b.uuids.push(c.getCanonicalUUID(a))}),a.advertisementData.kCBAdvDataServiceData)for(var d in a.advertisementData.kCBAdvDataServiceData){var e=a.advertisementData.kCBAdvDataServiceData[d];b.adData.serviceData[c.getCanonicalUUID(d)]=t(o(e))}a.advertisementData.kCBAdvDataManufacturerData&&(b.adData.manufacturerDataRaw=a.advertisementData.kCBAdvDataManufacturerData)}}function m(a,b){for(var d=o(a.scanRecord),e=0;e<d.length;){var f=d[e++];if(0===f)break;f-=1;var g,h=d[e++];if(8===h||9===h)b.name=evothings.ble.fromUtf8(new Uint8Array(d.buffer,e,f)).replace("\x00","");else if(10===h)b.adData.txPower=p(d,e);else if(2===h||3===h)for(g=0;f>g;g+=2)b.uuids.push(c.getCanonicalUUID(q(d,e+g).toString(16)));else if(4===h||5===h)for(g=0;f>g;g+=4)b.uuids.push(c.getCanonicalUUID(r(d,e+g).toString(16)));else if(6===h||7===h)for(g=0;f>g;g+=16)b.uuids.push(c.getCanonicalUUID(s(d,e+g)));e+=f}}function n(a){return a>64&&91>a?a-65:a>96&&123>a?a-71:a>47&&58>a?a+4:43===a?62:47===a?63:0}function o(a,b){for(var c,d,e=a.replace(/[^A-Za-z0-9\+\/]/g,""),f=e.length,g=b?Math.ceil((3*f+1>>2)/b)*b:3*f+1>>2,h=new Uint8Array(g),i=0,j=0,k=0;f>k;k++)if(d=3&k,i|=n(e.charCodeAt(k))<<18-6*d,3===d||f-k===1){for(c=0;3>c&&g>j;c++,j++)h[j]=i>>>(16>>>c&24)&255;i=0}return h}function p(a,b){var c=a[b];return 128&c&&(c-=256),c}function q(a,b){return(a[b+1]<<8)+a[b]}function r(a,b){return(a[b+3]<<24)+(a[b+2]<<16)+(a[b+1]<<8)+a[b]}function s(a,b){for(var c="",d=0;16>d;d++)c+=("00"+a[b+d].toString(16)).slice(-2);return c}function t(a){var b=new Uint8Array(a).buffer;return new DataView(b)}function u(){return a.cordova?a.cordova.platformId:null}function v(){return"ios"===u()}var w={},x={},y={},z={},A={},B={};b._addAdapter("evothings",w),w.startScan=function(a,b,c,e){d(function(){evothings.ble.stopScan(),evothings.ble.startScan(a,function(a){b&&b(k(a))},function(a){e&&e(a)}),c&&c()})},w.stopScan=function(a){d(function(){evothings.ble.stopScan()})},w.connect=function(a,b,c,d){evothings.ble.connect(a,function(d){2===d.state&&b?(x[a]=d.deviceHandle,b()):0===d.state&&b&&(e(a),c())},function(a){d&&d(a)})},w.disconnect=function(a,b){e(a)},w.discoverServices=function(a,b,d,e){var f=g(a,e);f&&evothings.ble.services(f,function(a){var e=[];a.forEach(function(a){var d=c.getCanonicalUUID(a.uuid),g=!b||0===b.length||b.indexOf(d)>=0;g&&(y[a.handle]=f,e.push({_handle:a.handle,uuid:d,primary:!0}))}),d&&d(e)},function(a){e&&e(a)})},w.discoverIncludedServices=function(a,b,c,d){c([])},w.discoverCharacteristics=function(a,b,d,e){var f=h(a,e);f&&evothings.ble.characteristics(f,a,function(a){var e=[];a.forEach(function(a){var d=c.getCanonicalUUID(a.uuid),g=!b||0===b.length||b.indexOf(d)>=0;g&&(z[a.handle]=f,e.push({_handle:a.handle,uuid:d,properties:{broadcast:1&a.property,read:2&a.property,writeWithoutResponse:4&a.property&&1&a.writeType,write:8&a.property,notify:16&a.property,indicate:32&a.property,authenticatedSignedWrites:64&a.property&&4&a.writeType,reliableWrite:!1,writableAuxiliaries:!1}}))}),d&&d(e)},function(a){e&&e(a)})},w.discoverDescriptors=function(a,b,d,e){var f=i(a,e);f&&evothings.ble.descriptors(f,a,function(e){var g=[];e.forEach(function(d){var e=c.getCanonicalUUID(d.uuid);"00002902-0000-1000-8000-00805f9b34fb"===e&&(B[a]=d.handle);var h=!b||0===b.length||b.indexOf(e)>=0;h&&(A[d.handle]=f,g.push({_handle:d.handle,uuid:e}))}),d&&d(g)},function(a){e&&e(a)})},w.readCharacteristic=function(a,b,c){var d=i(a,c);d&&evothings.ble.readCharacteristic(d,a,function(a){b&&b(t(a))},function(a){c&&c(a)})},w.writeCharacteristic=function(a,b,c,d){var e=i(a,d);e&&evothings.ble.writeCharacteristic(e,a,b,function(){c&&c()},function(a){d&&d(a)})},w.enableNotify=function(a,b,c,d){function e(){evothings.ble.enableNotification(f,a,function(a){b&&b(t(a))},function(a){d&&d(a)}),c&&c()}var f=i(a,d);f&&j(f,a,e,function(a){d&&d(a)})},w.disableNotify=function(a,b,c){var d=i(a,c);d&&(evothings.ble.disableNotification(d,a,function(){b&&b()},function(a){c&&c(a)}),v()&&setTimeout(b,0))},w.readDescriptor=function(a,b,c){var d=getDeviceHandleFromDescriptorHandle(a,c);d&&evothings.ble.readDescriptor(d,a,function(a){b&&b(t(a))},function(a){c&&c(a)})},w.writeDescriptor=function(a,b,c,d){var e=getDeviceHandleFromDescriptorHandle(a,d);e&&evothings.ble.writeDescriptor(e,a,b,function(){c&&c()},function(a){d&&d(a)})}});